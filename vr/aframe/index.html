<!DOCTYPE html>

<html>
  <head>
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <script>
      AFRAME.registerComponent( 'foe', {
        schema: {
          numNodes: { default: 1 }
        },
        init: function() {
          this.numNodes = this.data.numNodes;
          for ( i = 1; i <= this.numNodes; i++ )
          {
            var newCombatNodeElement = document.createElement('a-entity');
            var position = { x:0, y:2*i, z:0 };
            var maxNodeX = 4;
            var maxNodeY = 4;
            var maxNodeZ = 4;
            position.x = Math.floor( ( Math.random() * 2*maxNodeX ) - maxNodeX );
            position.y = Math.floor( ( Math.random() * 2*maxNodeY ) - maxNodeY );
            position.z = Math.floor( ( Math.random() * maxNodeZ ) - maxNodeZ ); //Only in one dimension.
            newCombatNodeElement.setAttribute( 'combat-node', { positionOffset:position } );
            this.el.appendChild( newCombatNodeElement );
          }
        },
        onAllNodesPopped: function() {
          //Foe defeated logic here.
          console.log("Foe defeated!");
        },
        onNodePopped: function() {
          console.log("Parent received pop!");
        	--this.numNodes;
          if ( this.numNodes == 0 )
            this.onAllNodesPopped();
        }
      } );
    </script>
    <script>
      //Goal: can pop a single node.
      AFRAME.registerComponent( 'combat-node', {
        multiple: true, //Can have more than one instance of combat-node component on an entity.
        schema: {
          positionOffset: { default: {x:0, y:0, z:0} },
          gazeTimeSeconds: { default: 0.0 }
        },
        getRandomColor: function() { //Concatenate 0 to F six times.
          var colorStr = '#';
          var letters = '0123456789ABCDEF';
          for ( var strIndex = 0; strIndex < 6; strIndex++ ) {
            var pickedLetterIndex = Math.floor( Math.random() * 16 );
            colorStr += letters[ pickedLetterIndex ];
          }
          return colorStr; 
        },
        init: function() {
          this.data.isPopping = false;
          this.el.setAttribute( 'geometry', { primitive: 'sphere', width:4, height:1 } );
          this.initialColor = this.getRandomColor();
          this.el.setAttribute( 'material', { color:this.initialColor, wireframe:true } );
          this.el.setAttribute( 'position', this.data.positionOffset );
          
          var _self = this; //Else we can't reference the component.data in handlers below.
          this.el.addEventListener( 'mouseenter', function() { _self.data.isPopping = true; } );
          this.el.addEventListener( 'mouseleave', function() { _self.data.isPopping = false; } );
        },
        tick: function() {
          if ( this.data.isPopping )
          {
            //this.el.sceneEl.removeObject3D("self"); //?
            this.el.setAttribute( 'material', 'color', 'red' );
          }
          else
          {
            this.el.setAttribute( 'material', 'color', this.initialColor );
          }
        }
      } );
    </script>
  </head>
  
  <body>
    <a-scene>
      <a-text foe="numNodes:3" value="hi" color="red" position="0 2 -3"></a-text>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
      <a-camera>
        <a-cursor></a-cursor>
      </a-camera>
    </a-scene>
  </body>
</html>
