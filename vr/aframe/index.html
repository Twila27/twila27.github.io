<!DOCTYPE html>

<html>
  <head>
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <script src="components/foes.js"></script>
    <script src="components/waypoints.js"></script>
    <script src="https://rawgit.com/chenzlabs/auto-detect-controllers/master/dist/aframe-auto-detect-controllers-component.min.js"></script>
    <script src="https://rawgit.com/chenzlabs/gearvr-controls/master/dist/aframe-gearvr-controls-component.min.js"></script>
    <script>
        AFRAME.registerComponent( 'spawn-foes-on-click', {
          getRandomPosition: function() {
            var position = { x:0, y:0, z:0 };
            var maxNodeX = 8;
            var maxNodeY = maxNodeX/2;
            var maxNodeZ = maxNodeX;
            position.x = Math.floor( ( Math.random() * 2*maxNodeX ) - maxNodeX );
            position.y = Math.floor( ( Math.random() * maxNodeY ) - maxNodeY ); //Can be negative XZ coords, but only +y.
            position.z = Math.floor( ( Math.random() * 2*maxNodeZ ) - maxNodeZ );
            return position;
          },
          spawn: function( self ) { 
            console.log("In spawner func spawn");
            var newFoe = self.el.sceneEl.components.pool__foes.requestEntity(); 
            newFoe.setAttribute( 'position', this.getRandomPosition() );
          },
          init: function() {
            var _self = this; //Have to be sure to do this to self-ref the spawn func below.
            this.el.addEventListener( 'click', function() { _self.spawn( _self ); } );
          }
        } );
    </script>
  </head>
  
  <body>
    <a-scene pool_foes="mixin:gazetimerFoePrefab; size: 5" pool__combatNodes="mixin:combatNodePrefabMesh combatNodePrefabMaterial; size:10" pool__waypoints="mixin:waypointPrefab; size:10">
      <a-assets>
        <a-mixin id="avatarCursor" cursor cursor-listener position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02; segmentsTheta: 64"
                  material="opacity: 0.8; shader: flat; color: #000"></a-mixin>
        
        <a-mixin id="gazetimerFoePrefab" 
                 text="value:Rawr, I'm a gazetimer monster;
                       color:red"
                 foe="numNodes:3;
                   nodePopSFX:assets/Amalgamate.wav;
                   dieSFX:assets/Shinsei by Gichco.mp3;
                   nodeGazeTimeMilliseconds:3000.0"></a-mixin>
        
        <a-mixin id="popcornFoePrefab" 
                 text="value:Rawr, I'm a popcorn monster;
                       color:red"
                 foe="numNodes:3;
                   nodePopSFX:assets/Amalgamate.wav;
                   dieSFX:assets/Shinsei by Gichco.mp3"></a-mixin>
        
        <a-mixin id="combatNodePrefabMesh" geometry="primitive:sphere"></a-mixin>
        <a-mixin id="combatNodePrefabMaterial" material="color:#FFF" ></a-mixin>
        <a-mixin id="waypointPrefab" waypoint geometry="primitive:cylinder;height:0.01;radius:1.0" material="color:yellow"></a-mixin>
        
        <img id="skyTexture" src="assets/reactvr-meshsample/chess-world.jpg"/>
        
      </a-assets>

      <a-sky src="#skyTexture"></a-sky>
      
      <a-box spawn-foes-on-click material="color:red" position="0 2 -10"></a-box>
      
      <a-plane class="floor" position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
      
      <!-- If detected, will use built-in controller model (e.g. Oculus Touch or Vive) -->
     <a-entity id="lefthand" auto-detect-controllers="hand:left"></a-entity>
     <a-entity id="righthand" auto-detect-controllers="hand:right"></a-entity>
      
      <a-camera id="keysWorldCamera" active="true">
        <a-entity raycaster="objects: .floor, .waypoint" mixin="avatarCursor"></a-entity>
      </a-camera>
      
      <a-camera id="foesWorldCamera" active="false">
        <a-entity raycaster="objects: .waypoint" mixin="avatarCursor"></a-entity>
      </a-camera>

    </a-scene>
  </body>
</html>
